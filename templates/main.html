<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rutgers to NJ Community College Course Equivalency Lookup</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 20px;
            text-align: center;
        }

        h1 {
            color: #333;
        }

        #search-form {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 20px;
        }

        #search-bar {
            width: 250px;
            padding: 10px;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 5px 0 0 5px;
        }

        #search-results {
            margin-top: 20px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            background-color: #f9f9f9;
            text-align: left;
        }

    </style>
</head>
<body>
    <form id="search-form">
        <input type="text" id="search-bar" placeholder="Enter your search">
        <button type="submit">Search</button>
    </form>
    <div id="search-results"></div>

    <script>
        // Get user's location when the page loads  
        window.onload = function() {
             getLocation();
        };

    // Get user's location
    function getLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(sendPosition, showError);
        } else {
            document.getElementById("location").innerHTML = "Geolocation is not supported by this browser.";
        }
    }

    // Send user's location to the server
    function sendPosition(position) {
        var latitude = position.coords.latitude;
        var longitude = position.coords.longitude;

        fetch('/save_location', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                latitude: latitude,
                longitude: longitude
            })
        })
        .then(response => response.json())
        .then(data => {
            console.log('Success:', data);
        })
        .catch((error) => {
            console.error('Error:', error);
        });
    }

    // Handle errors for locations
    function showError(error) {
        switch(error.code) {
            case error.PERMISSION_DENIED:
                document.getElementById("location").innerHTML = "User denied the request for Geolocation.";
                break;
            case error.POSITION_UNAVAILABLE:
                document.getElementById("location").innerHTML = "Location information is unavailable.";
                break;
            case error.TIMEOUT:
                document.getElementById("location").innerHTML = "The request to get user location timed out.";
                break;
            case error.UNKNOWN_ERROR:
                document.getElementById("location").innerHTML = "An unknown error occurred.";
                break;
        }
    }

    //search by title
    document.getElementById('search-form').addEventListener('submit', function(event) {
        event.preventDefault();
        clearSearch();
        search();
    });

    //clear search results
    function clearSearch() {
        var resultsContainer = document.getElementById('search-results');
        resultsContainer.innerHTML = '';
    }

    // Save the courses to the cache
    function saveCourses(searchTerm, courses) {
        localStorage.setItem(searchTerm, JSON.stringify(courses));
    }

    // Get the courses from the cache
    function getCachedCourses(searchTerm) {
        const cachedData = localStorage.getItem(searchTerm);
        return cachedData ? JSON.parse(cachedData) : null;
    }

    //search by title
    function search() {
        var searchTerm = document.getElementById('search-bar').value;

        // Check if the results are in the cache
        const cachedCourses = getCachedCourses(searchTerm);
        if (cachedCourses) {
            displayCourses(cachedCourses);
            return;
        }

        fetch('/search_by_title', {
            method: "POST",
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ searchTerm: searchTerm }),
        })
        .then(response => response.json())
        .then(data => {
            var courses = data.courses || [];
            
            // Save the courses to the cache
            saveCourses(searchTerm, courses);

             // Display the courses
            displayCourses(courses);
        });
    }

    // Display the courses
    function displayCourses(courses) {
        var coursesContainer = document.getElementById('search-results');
        coursesContainer.innerHTML = '';

        if (courses.length > 0) {
            courses.forEach(function(course) {
                var titleElement = document.createElement('p');
                titleElement.textContent = course.course_number + " " + course.title;
                coursesContainer.appendChild(titleElement);

                if (course.instructors.length > 0) {
                    var professorsElement = document.createElement('p');
                    professorsElement.textContent = 'Professors: ';

                    for (var i = 0; i < course.instructors.length; i++) {
                        var professor = course.instructors[i][0];
                        professorsElement.textContent += professor.name;

                        if (i < course.instructors.length - 1) {
                            professorsElement.textContent += ', ';
                        }
                    }

                    coursesContainer.appendChild(professorsElement);
                }
                
                var descriptionElement = document.createElement('p');
                descriptionElement.textContent = course.gpt_description;
                coursesContainer.appendChild(descriptionElement);

                // Display the equivalencies
                if (course.equivalencies && course.equivalencies.length > 0) {
                    var equivalencyElement = document.createElement('p');
                    equivalencyElement.textContent = 'Equivalencies: ';
                    course.equivalencies.forEach(function(equiv, index) {
                        equivalencyElement.textContent += equiv.community_college + ' (' + equiv.Distance +' miles'+')'+ ' - ' + equiv.code + ' ' + equiv.name;
                        if (index < course.equivalencies.length - 1) {
                            equivalencyElement.textContent += ', ';
                        }
                    });
                    coursesContainer.appendChild(equivalencyElement);
                } else {
                    var noEquivElement = document.createElement('p');
                    noEquivElement.textContent = 'No equivalencies found.';
                    coursesContainer.appendChild(noEquivElement);
                }

                var separatorElement = document.createElement('hr');
                coursesContainer.appendChild(separatorElement);
            });
        } else {
            var messageElement = document.createElement('p');
            messageElement.textContent = 'No search results found.';
            coursesContainer.appendChild(messageElement);
        }
    }
    </script>
</body>
</html>